<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
  <title>api-url-editor test</title>
  <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <link rel="import" href="../api-url-editor.html">
</head>

<body>
  <test-fixture id="basic">
    <template>
      <api-url-editor></api-url-editor>
    </template>
  </test-fixture>
  <test-fixture id="required">
    <template>
      <api-url-editor required error-message="error"></api-url-editor>
    </template>
  </test-fixture>
  <test-fixture id="auto">
    <template>
      <api-url-editor auto-validate required error-message="error"></api-url-editor>
    </template>
  </test-fixture>
  <test-fixture id="events">
    <template>
      <api-url-editor auto-validate required base-uri="https://domain.com" endpoint-path="/{path}"></api-url-editor>
    </template>
  </test-fixture>
  <script>

  suite('_getValidity()', () => {
    suite('Not required field', () => {
      let input;
      setup((done) => {
        input = fixture('basic');
        flush(() => done());
      });

      test('Valid when not required end empty value', () => {
        input.value = '';
        const result = input._getValidity();
        assert.isTrue(result);
      });

      test('Valid when value is undefined', () => {
        input.value = undefined;
        const result = input._getValidity();
        assert.isTrue(result);
      });

      test('Invalid for variables', () => {
        input.value = '{test}';
        const result = input._getValidity();
        assert.isFalse(result);
      });

      test('Invalid for invalid URL value', () => {
        input.value = 'some value not URL';
        const result = input._getValidity();
        assert.isFalse(result);
      });
    });

    suite('Required field', () => {
      let input;
      setup((done) => {
        input = fixture('required');
        flush(() => done());
      });

      test('Invalid when empty value', () => {
        input.value = '';
        const result = input._getValidity();
        assert.isFalse(result);
      });

      test('Valid when value is undefined', () => {
        input.value = undefined;
        const result = input._getValidity();
        assert.isTrue(result);
      });
    });
  });

  suite('Auto validation', () => {
    let input;
    setup((done) => {
      input = fixture('auto');
      flush(() => done());
    });

    test('Valid for valid value', () => {
      input.value = 'https://domain.com?a=b&param=value#1232344';
      assert.isFalse(input.invalid);
    });

    test('Invalid for variables', () => {
      input.value = 'https://domain.com?{a}=b&param=value#1232344';
      assert.isTrue(input.invalid);
    });

    test('Invalid when chanding value back to empty stirng', () => {
      input.value = 'https://domain.com';
      assert.isFalse(input.invalid);
      input.value = '';
      assert.isTrue(input.invalid);
    });

    test('Invalid for invalid URL value', () => {
      input.value = 'some value not URL';
      assert.isTrue(input.invalid);
    });
  });

  suite('Validation with query events', () => {
    let element;
    const invalidUrl = 'https://domain.com/{path}/?{param}=value';
    const uriModel = {
      name: 'path',
      required: true,
      type: 'string'
    };
    const queryModel = {
      description: '',
      name: 'param',
      required: true,
      type: 'string'
    };

    setup((done) => {
      element = fixture('events');
      element.queryModel = [Object.assign({}, queryModel)];
      element.pathModel = [Object.assign({}, uriModel)];
      element.value = invalidUrl;
      flush(() => done());
    });

    test('Invalid by default', function() {
      const valid = element.validate();
      assert.isFalse(valid);
    });

    test('Valid after uri param update', function() {
      element.set('pathModel.0.value', 'test');
      const valid = element.validate();
      assert.isTrue(valid);
    });
  });
  </script>
</body>

</html>
